var isSend=!1,isShowWifi=!1,wifiList=[],timeoutNum=0,Ajax={get:function(e,t){var i;window.XMLHttpRequest?i=new XMLHttpRequest:window.ActiveObject&&(i=new ActiveXobject("Microsoft.XMLHTTP")),i.open("GET",e,!0),i.onreadystatechange=function(){4==i.readyState&&(200==i.status||304==i.status?t.call(this,i.responseText):(showMessage(getPrompt("requestFailed"),1e3),hideLoading("msg-load")))},i.send()},post:function(e,t,i){var n;showLoading(),window.XMLHttpRequest?n=new XMLHttpRequest:window.ActiveObject&&(n=new ActiveXobject("Microsoft.XMLHTTP")),n.open("POST",e,!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),n.onreadystatechange=function(){4==n.readyState&&(200==n.status||304==n.status?i.call(this,n.responseText):(hideLoading("msg-load"),showMessage(getPrompt("connectFailed"),2e3)))},n.send(t)},postFile:function(e,t,i){var n;showLoading(),window.XMLHttpRequest?n=new XMLHttpRequest:window.ActiveObject&&(n=new ActiveXobject("Microsoft.XMLHTTP")),n.open("POST",e,!0),n.setRequestHeader("Content-Type","application/octet-stream;charset=UTF-8"),n.onreadystatechange=function(){4==n.readyState&&(200==n.status||304==n.status?i.call(this,n.responseText):(hideLoading("msg-load"),showConfirm(getPrompt("prompt"),getPrompt("otaFailed"),getPrompt("confirm"))))},n.send(t)}};const constHtmlLang=[{zh:"Wi-Fi Access Point",en:"Wi-Fi Access Point",id:"esp-iot-bridge-ap-link",type:"text"},{zh:"設備配網",en:"Wi-Fi",id:"esp-iot-bridge-link",type:"text"},{zh:"OTA 升級",en:"OTA",id:"esp-ota-link",type:"text"},{zh:"歡迎使用 ESP-IoT-Bridge 配網",en:"Welcome to ESP-IoT-Bridge Web",id:"welcome-wrap",type:"text"},{zh:"請輸入 AP_SSID",en:"AP_SSID",id:"ap_ssid",type:"input"},{zh:"請輸入 AP_PASSWORD",en:"AP_PASSWORD",id:"ap_password",type:"input"},{zh:"設定",en:"Setup",id:"setup-ap",type:"text"},{zh:"請輸入 SSID",en:"SSID",id:"ssid",type:"input"},{zh:"請輸入 PASSWORD",en:"PASSWORD",id:"password",type:"input"},{zh:"開始配網",en:"Connect",id:"start-connect",type:"text"},{zh:"注意：",en:"Note: ",id:"note-text",type:"text"},{zh:"配網手機作為待接入熱點時，瀏覽器可能收不到配網結果",en:"Please note that if your target AP is the hotspot of the device which opens the web pages, you may not receive the Wi-Fi connection result.",id:"note-desc",type:"text"},{zh:"請選擇新版本固件，然後點擊升級按鈕進行升級：",en:"Please select a new firmware and click the “OTA upgrade” button to start the upgrade: ",id:"ota-title",type:"text"},{zh:"瀏覽",en:"Browse",id:"file-btn",type:"text"},{zh:"固件升級",en:"OTA upgrade",id:"start-upgrade",type:"text"},{zh:"當前 app 固件版本：",en:"Current app version: ",id:"cur-version",type:"text"},{zh:"固件版本：",en:"Firmware version: ",id:"at-version",type:"text"}],constPromptInfo={prompt:{zh:"提示",en:"Prompt"},confirm:{zh:"確定",en:"OK"},cancel:{zh:"取消",en:"Cancel"},requestFailed:{zh:"數據請求失敗",en:"Data request failed"},connectFailed:{zh:"配網失敗, 請重試",en:"Connection failed"},connectTimeout:{zh:"配網超時, 請重試",en:"Connection timeout"},connectSuc:{zh:"配網成功",en:"Connection succeeded"},upgradeFailed:{zh:"升級失敗，請稍後重試",en:"Upgrade failed. Please try again later."},enterSsid:{zh:"請輸入 SSID",en:"Please enter SSID"},ssidError:{zh:"輸入 SSID 過長，請保持在32個字節之內",en:"The SSID is too long. Please keep it within 32 bytes"},passwordError:{zh:"輸入 Password 過長，請保持在64個字節之內",en:"Password is too long. Please keep it within 64 bytes"},closedWeb:{zh:'配網成功， <span id="timeout-info" class="timeout-info">5</span> 秒後自動關閉網頁',en:'Connection succeeded, This page will be closed in <span id="timeout-info" class="timeout-info">5</span> seconds.'},wifiList:{zh:"Wi-Fi 列表",en:"Wi-Fi List"},refresh:{zh:"刷新",en:"Refresh"},getWifiFailed:{zh:"獲取 Wi-Fi 列表失敗",en:"Failed to get Wi-Fi AP list"},noData:{zh:"暫無數據",en:"No data available"},selectFile:{zh:"請選擇文件",en:"Please select file"},formatError:{zh:"選擇的文件格式有誤",en:"Incorrect file format"},fileLarge:{zh:"選擇的文件過大，請選擇小於 2MB 的文件",en:"File is too large. Please select a file less than 2MB."},getVersionFailed:{zh:"獲取固件版本失敗",en:"Failed to get firmware version"},otaSuc:{zh:"升級成功",en:"OTA Succeeded"},otaFailed:{zh:"升級失敗，請稍後重試",en:"OTA Failed"}};var curLangeage="en";function loadLanguage(){var e=navigator.language||navigator.userLanguage;e=e.substr(0,2),curLangeage="zh"==e?"zh":"en";for(var t=0;t<constHtmlLang.length;t++){var i=constHtmlLang[t];"input"!=i.type?setTextByLang(i.id,i[curLangeage]):setInputByLang(i.id,i[curLangeage])}}function setTextByLang(e,t){var i=document.getElementById(e);i&&(i.innerText=t)}function setInputByLang(e,t){document.getElementById(e).setAttribute("placeholder",t)}function getPrompt(e){return constPromptInfo[e][curLangeage]}function getData(){Ajax.get("/getstainfo",(function(e){e=JSON.parse(e);try{document.getElementById("ap_ssid").value=e.ap_ssid,document.getElementById("ap_password").value=e.ap_password,document.getElementById("ssid").value=e.sta_ssid,document.getElementById("password").value=e.sta_password,document.getElementById("message").value=e.message}catch(e){}}))}function getStatus(){if(timeoutNum>40)return hideLoading("msg-load"),showMessage(getPrompt("connectTimeout"),2e3),!1;timeoutNum++,Ajax.get("/getstainfo",(function(e){e=JSON.parse(e),document.getElementById("message").value=e.message,1==e.state?getResult():0==e.state?setTimeout((function(){getStatus()}),1e3):(hideLoading("msg-load"),showMessage(getPrompt("connectFailed"),2e3))}))}function getResult(){Ajax.post("/getresult","received=1",(function(e){isSend=!1,hideLoading("msg-load"),showTimeout()}))}function postApData(){var e=document.getElementById("ap_ssid").value,t=document.getElementById("ap_password").value;if(""==e||null==e)return showMessage(getPrompt("enterSsid"),1e3),!1;if(e.length>32)return showMessage(getPrompt("ssidError"),1e3),!1;if(t.length>64)return showMessage(getPrompt("passwordError"),1e3),!1;var i="ap_ssid="+e+"&ap_password="+t;Ajax.post("/setapinfo",i,(function(e){e=JSON.parse(e),isSend=!0,showMessage("Saving AP configuration and Restarting the device...",5e3),setTimeout((function(){location.reload()}),5e3)}))}function postData(){timeoutNum=0;var e=document.getElementById("ssid").value,t=document.getElementById("password").value;if(""==e||null==e)return showMessage(getPrompt("enterSsid"),1e3),!1;if(e.length>32)return showMessage(getPrompt("ssidError"),1e3),!1;if(t.length>64)return showMessage(getPrompt("passwordError"),1e3),!1;var i="sta_ssid="+e+"&sta_password="+t;Ajax.post("/setstainfo",i,(function(e){e=JSON.parse(e),isSend=!0,0==e.state?setTimeout((function(){getStatus()}),1e3):(hideLoading("msg-load"),showMessage(getPrompt("connectFailed"),2e3))}))}function showMessage(e,t){var i=document.getElementById("body-wrap"),n=document.createElement("div");n.innerHTML='<div class="content">'+e+"</div>",n.setAttribute("class","msg"),i.appendChild(n),t&&setTimeout((function(){i.removeChild(n)}),t)}function showTimeout(){hideLoading("msg-load");var e=document.getElementById("body-wrap"),t=document.createElement("div");t.innerHTML='<div id="timeoutId" class="content-time">'+getPrompt("closedWeb")+"</div>",t.setAttribute("class","msg"),e.appendChild(t);var i=5,n=setInterval((function(){i--,document.getElementById("timeout-info").innerText=i,i<0&&(e.removeChild(t),closeWindow(),clearInterval(n))}),1e3)}function closeWindow(){window.open("about:blank","_self").close()}function showLoading(){var e=document.getElementById("body-wrap"),t=document.createElement("div");t.innerHTML='<div class="load"><div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div></div>',t.setAttribute("class","msg"),t.setAttribute("id","msg-load"),e.appendChild(t)}function showConfirm(e,t,i){var n=document.getElementById("body-wrap"),o=document.createElement("div");o.innerHTML='<div class="mask"></div><div class="content"><div class="header">'+e+'</div><div class="content-info">'+t+'</div><div onclick="removeConfirm()" class="footer-btn"><button>'+i+"</button></div></div>",o.setAttribute("class","msg-confirm"),o.setAttribute("id","msg-confirm"),n.appendChild(o)}function removeConfirm(){document.getElementById("body-wrap").removeChild(document.getElementById("msg-confirm"))}function hideLoading(e){var t=document.getElementById(e);t&&(t.setAttribute("class","msg hide"),document.getElementById("body-wrap").removeChild(t))}loadLanguage(),window.onbeforeunload=function(){if(isSend)try{if(!navigator.sendBeacon)return;navigator.sendBeacon("http://192.168.4.1/getresult","received=1")}catch(e){}};var isMobile=(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||768)<=768;function getaprecord(){showLoading(),Ajax.get("/getaprecord",(function(e){e=JSON.parse(e);try{0==e.state?(initWifiList(wifiList=e.aplist,null),hideLoading("msg-load")):showMessage(getPrompt("getWifiFailed"),2e3)}catch(e){showMessage(getPrompt("getWifiFailed"),2e3)}}))}function initWifiList(e,t){removeWifiList();var i=document.createElement("div");if(i.setAttribute("id","wifi-list-wrap"),i.setAttribute("class","wifi-list-wrap"),isMobile){var n=document.createElement("div");n.setAttribute("class","mask"),n.setAttribute("id","mask"),n.onclick=function(){removeWifiList()},i.appendChild(n)}for(var o=document.createElement("ul"),s="",a=document.getElementById("ssid").value,d=0;d<e.length;d++){var r=e[d];if(!t||-1!=r.ssid.indexOf(t)){var c="";a==r.ssid&&(c="active"),s+='<li data-value="'+r.ssid+'" onclick="selectCurWifi(event)" class="d-flex d-a-i '+c+'"><span class="selected"></span>'+r.ssid,r.auth_mode&&0!=r.auth_mode&&(s+='<span class="lock-img"><svg class="icon" width="12px" height="12px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M800.421 436.525H736.76V287.852c0-124.507-100.762-225.757-224.732-225.757-123.98 0-224.857 101.25-224.857 225.766v148.662h-63.593c-30.667 0-55.532 24.952-55.532 55.752v407.048c0 30.848 24.865 55.82 55.532 55.82h576.9c30.667 0 55.465-24.97 55.465-55.82V492.275c0-30.802-24.855-55.752-55.532-55.752zM543.203 706.409v88.88a7.354 7.354 0 0 1-7.282 7.325h-47.733a7.373 7.373 0 0 1-7.334-7.322V706.41c-22.423-11.518-37.953-34.602-37.953-61.659 0-38.288 30.945-69.425 69.07-69.425 38.183 0 69.138 31.136 69.138 69.415 0.057 27.067-15.473 50.152-37.905 61.659z m107.311-269.884H373.525V291.539c0-76.691 62.196-139.146 138.552-139.146 76.366 0 138.447 62.454 138.447 139.146v144.986z" fill="#666666" ></path></svg></span>'),s+="</li>"}}if(""==s&&(s='<li class="no-data">'+getPrompt("noData")+"</li>"),o.innerHTML=s,isMobile){var l=document.createElement("div");l.setAttribute("class","content");var u=document.createElement("div");u.innerHTML="<h3>"+getPrompt("wifiList")+'<span onclick="getaprecord()" id="refresh" class="refresh">'+getPrompt("refresh")+"</span></h3>";var m=document.createElement("div");return m.setAttribute("class","cancel-wrap"),m.setAttribute("id","cancel-wrap"),m.innerHTML=getPrompt("cancel"),m.onclick=function(){removeWifiList()},l.appendChild(u),l.appendChild(o),l.appendChild(m),i.appendChild(l),void document.getElementById("body-wrap").appendChild(i)}i.appendChild(o),document.getElementById("ssid-wrap").appendChild(i)}function selectCurWifi(e){isShowWifi=!1,document.getElementById("ssid").value=e.target.dataset.value,removeWifiList()}function initShowList(){document.getElementById("show-wifi-list").onclick=function(e){(isShowWifi=!isShowWifi)?getaprecord():removeWifiList(),document.getElementById("ssid").focus(),window.event?window.event.cancelBubble=!0:e.stopPropagation()},document.getElementById("ssid").onclick=function(e){window.event?window.event.cancelBubble=!0:e.stopPropagation()},document.getElementById("body-wrap").onclick=function(e){isMobile||(isShowWifi=!1,removeWifiList())},document.getElementById("ssid").oninput=function(){if(isShowWifi&&!isMobile){var e=document.getElementById("wifi-list-wrap");e&&(document.getElementById("ssid-wrap").removeChild(e),initWifiList(wifiList,this.value))}}}function removeWifiList(){isMobile&&(isShowWifi=!1);var e=document.getElementById("wifi-list-wrap");e&&(document.getElementById(isMobile?"body-wrap":"ssid-wrap").removeChild(e),(e=document.getElementById("wifi-list-wrap"))&&removeWifiList())}function fileChange(e){var t=e.files;if(t&&t.length>0){var i=(t=t[0]).name.toLowerCase();if(i.indexOf(".bin")!=i.length-4)return document.getElementById("file-info").value="",void showMessage(getPrompt("formatError"),2e3);if(t.size>=2097152)return document.getElementById("file-info").value="",void showMessage(getPrompt("fileLarge"),2e3);document.getElementById("file-name").value=i}}function getotainfo(){showLoading(),Ajax.get("/getotainfo",(function(e){e=JSON.parse(e);try{0==e.state?(document.getElementById("version-wrap").innerText=e.fw_version,document.getElementById("at-core-wrap").innerText=e.at_core_version,hideLoading("msg-load")):showMessage(getPrompt("getVersionFailed"),2e3)}catch(e){showMessage(getPrompt("getVersionFailed"),2e3)}}))}function postOta(){timeoutNum=0;var e=document.getElementById("file-info").files;e&&e.length>0?(e=e[0],Ajax.postFile("/setotadata",e,(function(e){e=JSON.parse(e),hideLoading("msg-load"),0==e.state?showConfirm(getPrompt("prompt"),getPrompt("otaSuc"),getPrompt("confirm")):showConfirm(getPrompt("prompt"),getPrompt("otaFailed"),getPrompt("confirm"))}))):showMessage(getPrompt("selectFile"),2e3)}function getEthernetIP(){Ajax.get("/getethinfo",(function(e){var t=JSON.parse(e);t&&t.ip?document.getElementById("eth-ip").innerText=t.ip:document.getElementById("eth-ip").innerText="Failed to retrieve IP"}))}function selectMenu(e,t){document.getElementById(e).classList.remove("hide"),t.classList.add("active"),"esp-iot-bridge-wrap"==e?(document.getElementById("esp-iot-bridge-ap-wrap").classList.add("hide"),document.getElementById("esp-iot-bridge-ap-link").classList.remove("active"),getData()):"esp-iot-bridge-ap-wrap"==e&&(document.getElementById("esp-iot-bridge-wrap").classList.add("hide"),document.getElementById("esp-iot-bridge-link").classList.remove("active"),getData())}window.onresize=function(){isMobile=(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||768)<=768},getData(),initShowList(),window.onload=function(){getEthernetIP()};